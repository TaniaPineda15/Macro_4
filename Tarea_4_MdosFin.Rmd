---
output: 
  pdf_document:
    includes:
      before_body: portada4.tex
      in_header: 
    toc: true
    toc_depth: 3
  tables: true
include-before:
- '`\newpage{}`{=latex}'
toc-title: Contenido
urlcolor: blue
header-includes:
- \usepackage[nottoc]{tocbibind}
- \renewcommand{\listfigurename}{Lista de figuras}
- \renewcommand{\listtablename}{Lista de tablas}
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}
- \usepackage{graphicx}
- \usepackage{float}
- \usepackage{lscape}
---

\newpage

\listoffigures

\listoftables

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align="center", fig.pos = "H", fig.width = 7, fig.height = 3)

pacman::p_load(tidyverse,
               ggthemes, ggfortify,
               haven, readxl,
               kableExtra,
               cowplot, ggplot2, scales, viridis, latticeExtra,
               knitr, tinytex, reshape, siebanxicor, lubridate, scales, reshape2,
               clusterGeneration, xtable, rsq, psych, jtools, inegiR, siebanxicor)
```
# Instrucciones

Realice los siguientes ejercicios con el equipo señalado.

# Ejercicio 1

Resuelva los ejercicios 10.4 y 10.5 (5a edición). Realice estos con ayuda de su laboratorista y entregue las soluciones escritas a máquina, utilizando
LaTeX. [1 hora, 1 punto cada pregunta] 

**Romer 10.4
Un enfoque más simple para los costos de agencia: compromiso limitado. (Lacker y Weinberg, 1989; Holmström y Tirole, 1998) Considere el modelo de la Sección 10.2 con una fricción diferente: no hay costo de verificar la producción, pero el empresario puede ocultar la fracción $1-f$ de la producción del proyecto al inversionista (con $0 \geq f \geq 1$). Por lo tanto, el emprendedor solo puede prometer de manera creíble pagar la fracción f de la producción del proyecto.** 

## a) 
**Considere un proyecto con el pago esperado $\gamma$ que excede $1 + r$. ¿Cuál es la condición para llevar a cabo el proyecto?**

El modelo asume 4 cosas: 1) La producción del proyecto $(X)$ se distribuye uniformemente sobre [0; 2$\gamma$], 2) El valor esperado de la produccion $E(x)=\gamma$, 3) El empresario y los inversores son neutrales al riesgo, 4) Existe una tecnología sin riesgo o información asimétrica que produce una tasa de retorno de r con seguridad, y 5) Los inversores externos son competitivos. 

El proyecto sera deseable socialmente si $\gamma>1+r$, como supone el problema. 

El empresario realizara el proyecto si la ganancia de este ($\gamma$) menos el pago al inversionista (R(D)) es mayor al escenario de invertir su riqueza (W) a una tasa r en otro proyecto, es decir:
$$ \gamma - R(D)>(1+r)W $$
$$ R(D) \leq \gamma - (1+r)W$$
De esta condicion se obtiene nuestro supuesto $\gamma>1+r$, por lo tanto, sabemos que el empresario realizara el proyecto.
$$ \Rightarrow \gamma-(1-r)+(1+r)W > (1+r)W$$
$$ \Rightarrow \gamma - (1-r)> 0$$
$$ \Rightarrow \gamma> (1+r)$$

Asimismo, al igual que el empresario, el inversionista aceptara el proyecto si los rendimientos esperados  son al menos el valor de sus pagos esperado si invirtiera en otro proyecto a una tasa r: 
$$ R(D)\geq (1-W)(1+r)$$ 
El punto en el que se maximiza la funcion de rendmientos esperados del inversor es en 2$\gamma$-c (donde 2$\gamma$ es la producción máxima posible del proyecto por la distribución supuesta, y c es el costo de verificación); en nuestro caso el punto máximo de esta función es 2$\gamma f$, pues supusimos que $c=0$ y se nos plantea que sólo la fracción $\gamma$f se puede pagar. 
Con base en la ecuacion 10.8 del Romer, el rendimiento maximo esperado por el inversionista es: 
$$ R^{MAX} = R(2\gamma f -c) \Rightarrow \left[ \frac{2\gamma f-c}{2\gamma f}\right]^2 \gamma f \Rightarrow \left[\frac{2\gamma f}{2\gamma f}\right]^2 \gamma f \Rightarrow \gamma f$$
Por lo tanto, 
$$R^{MAX}= \gamma f \geq (1-W)(1+r)$$

De ambas condiciones, podemos ver que el proyecto se realizara si se cumple lo siguiente:
$$ (1-W)(1+r) \leq R(D) \leq \gamma - (1+r)W$$ Con $$R^{MAX}= \gamma f$$

## b) 
**Suponga que la condición que encontró en la parte (a) se satisface con una desigualdad estricta.**

Ahora que nos aseguramos que el proyecto será llevado a cabo, tenemos que definir el pago realizado al inversionista en funcion de los resultados del proyecto, es decir, los valores que tomara nuestra variable R(D). 
De nuestro inciso anterior denotamos a X como la produccion del proyecto, ahora definiremos a $\hat{X}$ como el producto reportado, donde $\hat{X}$= fX. Asimismo, por el inciso a) sabemos que $\hat{X}$~ U(0,2f$\gamma$)

El valor de nuestra R(D), esta en funcion de dos escenarios. 

El primer caso, cuando D es menor o igual que la produccion maxima (2f$\gamma$), en este caso obtenemos una utilidad esperada, pues hay dos opciones: la probabilidad de que la produccion sea mayor o igual que D, donde el inversionista recibira la cantidad D, o la probabilidad de que la produccion sea menor que D, donde el inversionista recibira todo la produccion. 

El segundo caso, cuando D es mayor a la produccion maxima, donde en este caso recibira toda la produccion, ya que el ingreso del proyecto siempre sera menor a D. 

Construyendo estos casos de forma matematica tenemos:

Caso 1: 
$$E(D \leq 2f\gamma) = E(\hat{X}| \hat{X} \leq D)P(\hat{X} \leq D) + E(D)| \hat{X}>D)P(\hat{X} \geq D)$$
$$\Rightarrow \frac{D}{2}\frac{D}{2f\gamma} + D\frac{2f\gamma - D}{2f\gamma} \Rightarrow \frac{D^2}{4f\gamma} + D\left( 1- \frac{D}{2f\gamma}\right) \Rightarrow D- D\frac{D^2}{4f\gamma}$$ 
$$ \Rightarrow E(D< 2f\gamma)= D\left(1-\frac{D}{4f\gamma}\right)$$ 

Caso 2:
D > 2f$\gamma$, en este caso se le paga al inversionista la proporcion de la produccion que se prometio pagar: (f $\gamma$), que por el inciso anterior sabemos que es el rendimiento maximo que puede obtener el inversionista.

En resumen tenemos que el rendimiento del inversionista puede ser el siguiente:

\begin{equation}
	\label{eq:aqui-le-mostramos-como-hacerle-la-llave-grande}
	R(D) = \left\{
	\begin{array}{ll} 
		D\left(1- \frac{D}{4f\gamma}\right) \hspace{1cm} \mathrm{D\leq2f\gamma} \\
		f\gamma \hspace{2.6cm}  \mathrm{D>2f\gamma}
	\end{array}
	\right.
\end{equation} 

Nota: Esta $R^{MAX}$ tambien se puede obtener derivando el caso uno, $R'(D) \Rightarrow 2f\gamma = D^*$ y sustituyendo la D* optima encontrada en la funcion: $D\left(1- \frac{D}{4f\gamma}\right)$, obteniendo que $R(D^*) = R^{MAX}= f\gamma$  

Analizando la $R^{MAX}$ podemos concluir 3 cosas:

1. Si $R^{MAX}$<(1+r)(1-W) el inversionista no le presta a la empresa

2. Si $R^{MAX}$=(1+r)(1-W) habra varios valores de D que puedan otorgar este pago minimo requerido. Sin embargo, en el equilibrio competitivo, sera la D minima la que define este rendimiento, por el caso dos sabemos que esta D=2f$\gamma$, es cuando el pago esperado es menor a la produccion maxima del proyecto, $R^{MAX}= f\gamma$.

3. Si $R^{MAX}$>(1+r)(1-W) hay un valor unico de D, que le otorga al inversionista su pago minimo requerido. Es en este caso donde el contraro es unico. 

## c) 
**La capacidad de compromiso limitada conduce a la ineficiencia (en relación con el caso en que no hay fricciones) si** $\gamma>1+r$ **pero el proyecto no se lleva a cabo. Describa si cada uno de los siguientes puede hacer que un proyecto con** $\gamma> 1 + r$ **no se lleve a cabo:**

i) Una caída en la riqueza del emprendedor, W.

Si W cae, la condicion (1+r)(1-W) aumenta, lo que podria generar que $R^{MAX}$<(1+r)(1-W) y por lo tanto, que no se lleve a cabo el proyecto 

ii) Un aumento en la fracción del proyecto que el empresario puede ocultar, 1-f (es decir, una caída en f). 

Sabemos que $R^{MAX}$ = f$\gamma$, por lo que si f disminuye f$\gamma$ cae, lo que puede generar que $R^{MAX}$<(1+r)(1-W) y por lo tanto, que no se lleve a cabo el proyecto 

iii) Un aumento en el riesgo idiosincrásico. Concretamente, suponga que, la producción del proyecto se distribuye uniformemente en $[\gamma-b, \gamma+b]$ en lugar de uniformemente en $[0, 2\gamma]$, y hay un aumento en b.

Ahora tenemos que $X~U(\gamma-b, \gamma+b)$ y por lo tanto, $\hat{X}= fX~ U(f(\gamma-b), f(\gamma+b))^2$ 

Con esta informacion obtenemos 
$$  F_{\hat{X}} (x) = \frac{x}{f(\gamma +b)- f(\gamma -b)} =\frac{x}{2fb}$$

Si D $\leq$ f($\gamma$-b), la empresa le paga a la inversionista D con probabilidad 1. 

Si f($\gamma$-b) < D $\leq$ f($\gamma$+b), tenemos dos casos, como en el primer inciso: la probabilidad de que la produccion ($\hat{X}$) sea mayor o igual que D, donde el inversionista recibira la cantidad D, o la probabilidad de que la produccion sea menor que D, donde el inversionista recibira toda la produccion. 

$$E(D \leq 2f\gamma) = E(\hat{X}| \hat{X} \leq D)P(\hat{X} \leq D) + E(D)| \hat{X}>D)P(\hat{X} \geq D)$$
$$\Rightarrow \frac{f(\gamma-b + D)}{2} \frac{D}{2fb} + D\frac{2fb-D}{2fb} \Rightarrow \frac{D}{4fb} (f\gamma + 3fb -D)$$
$$ E(D \leq 2f\gamma) = D\left(\frac{3}{4} + \frac{f\gamma -D}{4fb}\right)$$

En resumen tenemos que el rendimiento del inversionista en este nuevo caso puede ser el siguiente:

\begin{equation} 
	R(D) = \left\{
	\begin{array}{ll} 
		D\left(\frac{3}{4} +\frac{f\gamma -D}{4fb}\right) \hspace{1cm} \mathrm{f(\gamma-b)< D \leq f(\gamma+b)} \\
		D \hspace{3.1cm}  \mathrm{ D \leq f (\gamma-b)}
	\end{array}
	\right.
\end{equation} 

Ante un aumento de b, no se cancelaria el proyecto, quiza solo en el caso donde D=f($\gamma$-b), ante el cambio de b a b' (con b'<b) D pasaria a ser mayor a f($\gamma$-b') cambiando solo los rendimientos que recibiria el inversionista. Sin embargo, este aumento de b tambien aumenta el nivel maximo de produccion, lo que implica que si antes D<f($\gamma$ +b), ahora el proyecto resultaria socialmente deseable. 

\pagebreak 

**Romer 10.5**

## a) 
**Demuestre que en el modelo analizado en las ecuaciones (10.15)-(10.23) de la sección 10.4,las distribuciones incondicionales de** $C_{2t}^{a}$ y  $C_{2t}^{n}$ **no son normales.**


## b) 
**Explique en una oración o dos por qué el análisis del texto, que usa las propiedades de las distribuciones lognormales, es correcto.**

# Ejercicio 2. 

**Estudie el financiamiento del sistema bancario en México a la luz del concepto de "transformación de madurez".**

## (a) 

**Obtenga, del SIE/Financiamiento e información financiera de intermediarios financieros/ del Banco de México, información de las formas de financiamiento del sector bancario (comercial) mexicano, y haga gráficas describiendo la evolución en el tiempo de las distintas tipos de financiamiento (depósitos a la vista, financiamiento de mercado y otros) y de la proporción que cada uno representa del total. Es decir, hay que producir dos gráficas de series de tiempo en la que el valor total está constituido por varias partes intermedias.**

\hfill

Para este ejercicio se recuperó la información pertinente desde julio del 2009, que provee el sitio de [Sistema de Información Económica](https://www.banxico.org.mx/SieInternet/consultarDirectorioInternetAction.do?sector=19&accion=consultarCuadro&idCuadro=CF832&locale=es) del Banco de México. A primera vista, la hoja de balance de la banca comercial en su conjunto se ve del siguiente modo:

| **Activos Totales**                | **Pasivos Totales más Capital**                    |
|----------------------------------|------------------------------------------------------|
| A. Disponibilidades              | D. Captación                                         |
| B. Bonos de regulación monetaria | E. Acreedores por reporto de valores                 |
| C. Financiamiento                | F. Financiamiento Interno                            |
|                                  | G. Financiamiento Externo                            |
|                                  | H.  Otros pasivos netos de otros activos más capital 
Table: 	Principales Activos y Pasivos de la Banca Comercial 


Asimismo, cada uno de estos rubros pueden desglosarse más detalladamente. La mayoría de los pasivos que en la tabla se contemplan fungen como fuentes de financiamiento para las instituciones bancarias. El apartado de *Captación*, *D*, contempla tarjetas de débito, tarjetas de crédito, cuentas de nómina y otros depósitos. El apartado *Acreedores por reporto de valores, E*, es otra fuente de financiamiento y, de acuerdo con el sitio web [Rankia](https://www.rankia.co/blog/analisis-colcap/4232308-que-son-operaciones-reporto-repo), consiste en "acuerdos de recompra de activos de renta fija entre un ahorrador y el banco". Los apartados *F* y *E* son más obvias. La parte sobre el *Financiamiento Interno* contempla a los recursos proveídos por el Banco de México, la Banca Comercial residente y otros intermediarios financieros públicos. 

Además, la base de datos que se mencionó al inicio divide a los pasivos de captación según su *madurez* o, en otras palabras, el plazo en que deben cumplirse tales obligaciones de financiamiento. En el siguiente cuadro se resumen esta información:

\newpage

| **Desglose de Pasivos**                      |                                           |                                         |                                    |
|------------------------------------------|-------------------------------------------|-----------------------------------------|------------------------------------|
| **D. Captación**                             | **E. Acreedores por reporto de valores**      | **F. Financiamiento Interno Recibido**      | **G. Financiamiento Externo Recibido** |
| D.1.Sector privado no bancario residente | E.1. Sector privado no bancario residente | F.1. Banco de México                    |                                    |
| D.2. Banca comercial                     | E.2. Banca comercial                      | F.2. Banca comercial                    |                                    |
| D.3. Otros intmds. Financieros públicos  | E.3. Banco de México                      | F.3. Otros intmds. Financieros públicos |                                    |
| D.4. Sector público no financiero        | E.4. Otros intmds. Financieros públicos   |                                         |                                    |
| D.5. Sector no residente                 | E.5. Sector público no financiero         |                                         |                                    |
|                                          | E.6. Sector no residente                  |

Table: Estructura del financiamiento recibido por los bancos

En las siguientes tablas se muestran algunas observaciones de los pasivos, así como el desglose de éstos en los rubros arriba mencionados. La primera tabla muestra el valor de estos pasivos en términos monetarios absolutos, mientras que la segunda tabla muestra tal valor como una proporción de los activos totales; es decir, la razón del rubro con el total. Note que para este ejercicio contamos con 153 observaciones. 

```{r, results='asis'}
base_fin_pas <- read_excel("Activos_Pasivos.xlsx", sheet = 2)
base_fin_pas <- base_fin_pas[-c(1:8),]


pas_gen <- as.data.frame(dplyr::select(base_fin_pas, c(1,2,3,19,26,30)))

names(pas_gen) <- c("Fecha", "Pasivos Totales", "Captación", "Acreedores-Reporto", "Fin. Interno", "Fin. Externo")

pas_gen$`Pasivos Totales` <- as.numeric(pas_gen$`Pasivos Totales`)
pas_gen$Captación <- as.numeric(pas_gen$Captación)
pas_gen$`Acreedores-Reporto` <- as.numeric(pas_gen$`Acreedores-Reporto`)
pas_gen$`Fin. Interno` <- as.numeric(pas_gen$`Fin. Interno`)
pas_gen$`Fin. Externo` <- as.numeric(pas_gen$`Fin. Externo`)


pas_gen_prop <- pas_gen %>% mutate(PTot = 100*pas_gen$`Pasivos Totales` / pas_gen$`Pasivos Totales`, PCap = 100*pas_gen$Captación / pas_gen$`Pasivos Totales`, PAc = 100*pas_gen$`Acreedores-Reporto`/pas_gen$`Pasivos Totales`, PFin = 100*pas_gen$`Fin. Interno`/pas_gen$`Pasivos Totales`, PFex = 100*pas_gen$`Fin. Externo`/pas_gen$`Pasivos Totales`) %>% dplyr::select(Fecha, PTot, PCap, PAc, PFin, PFex)


knitr::kable(headTail(pas_gen, 5,5), col.names = c("Fecha","Pasivos Totales", "Captación", "Acreedores-Reporto", "Fin. Interno", "Fin. Externo") ,format = "latex", booktabs = T, caption = "Pasivos de la Banca Comercial (Valor Absoluto) 2009-2022", align = "c") %>% kable_styling(latex_options = c("HOLD_position","scale_down"))


knitr::kable(headTail(pas_gen_prop,5,5), col.names = c("Fecha","Pasivos Totales", "Prop. Captación", "Prop. Acreedores-Reporto", "Prop. Fin. Interno", "Prop. Fin. Externo"), format = "latex", booktabs = T, caption = "Pasivos de la Banca Comercial \n (Proporción) 2009-2022", align = "c") %>% kable_styling(latex_options = c("HOLD_position", "scale_down")) 

pas_gen_prop <- pas_gen_prop[,-2]
```

Cabe mencionar que no se utilizó el apartado "Otros pasivos netos de otros activos más capital" por ser relativamente pequeño y por no estar muy bien detallado en la página del Banco. Por ello, es natural que la suma de los renglones no de 100\%.

```{r fig.width=9, fig.height=4, fig.pos='H',fig.cap='Variación Absoluta (2009-2022): Pasivos Bancarios'}
melt_df <- melt(pas_gen,id="Fecha")

ggplot(melt_df,aes(x=as.Date(Fecha, format = "%d/%m/%Y"),y=value,colour=variable,group=variable)) + geom_line() + labs(title = "Variación Absoluta (2009-2022): \nPasivos Bancarios (miles de pesos)", x="Tiempo",y='Pasivos', colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 
```

En esta gráfica se observa un incremento importante en los pasivos de la banca comercial, pasando de un nivel de \$3,986,846,051 (miles dp)  en 2009 hasta \$9,457,989,586 (miles dp) en marzo del 2022. Es decir, los pasivos experimentaron un incremento de `r (9457989586/3986846051 - 1)*100` \%. Asimismo, se observa que, aparentemente, este incremento se debe principalmente al alza del rubro de *captación*.

```{r fig.width=9, fig.height=4, fig.pos='H',fig.cap='Variación Relativa (2009-2022): Pasivos Bancarios'}
melt_df_2 <- melt(pas_gen_prop,id="Fecha")

ggplot(melt_df_2,aes(x=as.Date(Fecha, format = "%d/%m/%Y"),y=value,colour=variable,group=variable)) + geom_line() + labs(title = "Variación Proporcional (2009-2022): \nPasivos Bancarios (miles de pesos)", x="Tiempo",y='Pasivos \n(Porcentaje del Total)', colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 
```

En esta gráfica se observa que la proporción tanto del financiamiento interno como del externo se ha mantenido estable, sin mayores cambios en los últimos 13 años, mientras que la proporción de los acreedores por reporto de valores parece ir a la baja. Por otro lado, vemos que la proporción del rubro denominado captación se ha ido incrementando, por lo que parece ser cierto que el incremento en los pasivos se ha visto detonada (o al menos asociada) con el incremento en esta categoría.

Resulta de interés ese pequeño pico dado en los primeros meses del 2020, el cual es, a toda luz, efecto de la pandemia por el COVID-19. Es decir, la banca comercial experimentó mayores flujos de financiamiento gracias al sector interno a inicios la contingencia sanitaria.

## (b) 

**Obtenga de la misma fuente información del tipo de créditos que el sistema bancario (comercial) mexicano otorga, y haga gráficas describiendo la evolución en el tiempo de distintos tipos de crédito y de la proporción que cada uno representa del total. Al igual que en el inciso anterior, hay que producir dos gráficas de series de tiempo en la que el valor total está constituido por varias partes intermedias.**

En este incisco abordamos de manera más conciso el apartado de los activos, que en gran parte se constituyen por el financiamiento y el crédito que los bancos brindan a otras organziaciones y entidades públicas. De hecho, en la última observación de la base de datos que compete al mes de marzo de 2022, el financiamiento representa el 82\% de los activos totales. No debe sorprender, pues por definición éste es el principal propósito de una institución bancaria.  De este modo, conviene desprender el rubro *C* y conocer mejor en qué consiste este financiamiento. 

| **C. Financiamiento**                |                      |                        |
|--------------------------------------|----------------------|------------------------|
| **C.1.**                               | **C.2.**                 | **C.3.**                   |
| A sectores no bancarios internos     | A la banca comercial | Al sector no residente |
| **C.1.1.** Financiamiento directo      |                      |                        |
| Sector privado no bancario residente |                      |                        |
| Estados y municipios                 |                      |                        |
| Sector público federal               |                      |                        |
| Otros                                |
| **C.1.2.** Títulos asociados a programas de reestructura                                |
Table: Estructura del financiamiento otorgado por los bancos

Por cuestiones prácticas, la tabla provista por el Banco de México omite detalles que conviene repasar. El financiamiento dado al sector privado no bancario residente incluye, por ejemplo, crédito para el consumo y vivienda en el caso de los hogares, préstamos y valores para las empresas y personas físicas con actividad empresarial, programa de apoyo a deudores (ADES) en el caso del sector público, entre otras muchas especificaciones,

Desglosemos, entonces, la primer columna de esta tabla. Al igual que antes, lo haremos en sus versiones absolutas y relativas (proporcionales):

```{r, results='asis'}

base_fin_act <- read_excel("Activos_Pasivos.xlsx", sheet = 1)
base_fin_act <- base_fin_act[-c(1:8),]

act_gen <- as.data.frame(dplyr::select(base_fin_act, c(1,10,12,13,14,15,16)))

names(act_gen) <- c("Fecha", "Fin.Total", "Sector.Priv", "Edos.Muns", "Sect.Pub", "Otros", "Titulos")

act_gen$Fin.Total <- as.numeric(act_gen$Fin.Total)
act_gen$Sector.Priv <- as.numeric(act_gen$Sector.Priv)
act_gen$Edos.Muns <- as.numeric(act_gen$Edos.Muns)
act_gen$Sect.Pub <- as.numeric(act_gen$Sect.Pub)
act_gen$Otros <- as.numeric(act_gen$Otros)
act_gen$Titulos <- as.numeric(act_gen$Titulos)

act_gen_prop <- act_gen %>% mutate(FTot = 100*act_gen$Fin.Total/act_gen$Fin.Total, PPriv = 100*act_gen$Sector.Priv / act_gen$Fin.Total, PEdoMun = 100*act_gen$Edos.Muns / act_gen$Fin.Total, PSecPub= 100*act_gen$Sect.Pub/act_gen$Fin.Total, POtros = 100*act_gen$Otros/act_gen$Fin.Total, PTit = 100*act_gen$Titulos / act_gen$Fin.Total) %>% dplyr::select(Fecha, FTot, PPriv, PEdoMun, PSecPub, POtros, PTit)


knitr::kable(headTail(act_gen, 5,5), col.names = c("Fecha", "Fin. Total", "Sector Privado", "Edos. y Muns.", "Sector Púb.", "Otros", "Titulos asoc. progr. reest.") ,format = "latex", booktabs = T, caption = "Financiamiento Otorgado por la Banca Comercial (Valor Absoluto) 2009-2022", align = "c") %>% kable_styling(latex_options = c("HOLD_position","scale_down"))


knitr::kable(headTail(act_gen_prop,5,5), col.names = c("Fecha", "Fin. Total", "Prop. Sector Privado", "Prop. Edos. y Muns.", "Prop. Sector Púb.", "Prop. Otros", "Prop. Titulos"), format = "latex", booktabs = T, caption = "Financiamiento Otorgado por la Banca Comercial \n (Proporción) 2009-2022", align = "c") %>% kable_styling(latex_options = c("HOLD_position", "scale_down")) 

act_gen_prop <- act_gen_prop[,-2]

```

Es importante aclarar que aquí sólo se tomó, como se mencionó, la primera columna del Cuadro 5. Lo anterior con la finalidad de poder ilustrar los resultados de manera clara y concisa. Además, la participación que tienen los apartados *C.1.* y *C.2.* palidece ante la importancia de todo el sector *C.1.*

A continuación se muestran ambas gráficas; la primera muestra la variación absoluta del financiamiento otorgado y sus principales aristas a lo largo del tiempo, mientras que la segunda gráfica muestra la variación relativa / proporcional de dichas aristas como porcentaje del total del financiamiento otorgado.

```{r fig.width=9, fig.height=4, fig.pos='H',fig.cap='Variación Absoluta (2009-2022): Financiamiento Otorgado'}
melt_df_3 <- melt(act_gen,id="Fecha")

ggplot(melt_df_3,aes(x=as.Date(Fecha, format = "%d/%m/%Y"),y=value,colour=variable,group=variable)) + geom_line() + labs(title = "Variación Absoluta (2009-2022): \nFinanciamiento Otorgado (miles de pesos)", x="Tiempo",y='Financiamiento Otorgado', colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 
```
En esta figura puede verse que el financiamiento otorgado por la banca comercial ha ido en incremento en los últimos trece años. Al parecer, esta subida es impulsada de manera importante por el crédito otorgado al sector privado, el cual contempla empresas y hogares. Por su parte, las demás categorías se han mostrado relativamente estables a lo largo del tiempo considerado aquí. El cambio porcentual del financiamiento al sector privado durante el periodo fue de `r (5102253992/1772292102-1)*100` \%.

```{r fig.width=9, fig.height=4, fig.pos='H',fig.cap='Variación Relativa (2009-2022): Financiamiento Otorgado'}
melt_df_4 <- melt(act_gen_prop,id="Fecha")

ggplot(melt_df_4,aes(x=as.Date(Fecha, format = "%d/%m/%Y"),y=value,colour=variable,group=variable)) + geom_line() + labs(title = "Variación Proporcional (2009-2022): \nFinanciamiento Otorgado (miles de pesos)", x="Tiempo",y='Financiamiento Otorgado \n(Porcentaje del Total)', colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 
```
Igualmente, vemos un ligero aumento en la proporción $\frac{SectorPrivado}{Financiamiento Total}$ a lo largo del periodo. Los demás rubros se han mantenido en niveles similares, con excepción de la proporción del financiamiento al sector público, el cual ha mostrado variaciones importantes. Como lo ilustra la gráfica, éste venía cayendo desde el 2010, pero empieza a recuperarse alrededor del año 2020.

Podemos, asimismo, ahondar en el concepto de del Sector Privado y analizar el financiamiento otorgado a los hogares desde el 2009:

```{r}
base_sect_priv <- read_excel("SectorPrivado.xlsx", sheet = 1)
base_sect_priv <- base_sect_priv[-c(1:86),]
base_sect_priv <- base_sect_priv %>% dplyr::select(1,9,10,18,21)
base_sect_priv <- as.data.frame(base_sect_priv) 
names(base_sect_priv) <- c("Fecha", "CarteraCredito", "CreditoConsumo", "CreditoVivienda", "CreditoEmp")

base_sect_priv$CarteraCredito <- as.numeric(base_sect_priv$CarteraCredito)
base_sect_priv$CreditoConsumo <- as.numeric(base_sect_priv$CreditoConsumo)
base_sect_priv$CreditoVivienda <- as.numeric(base_sect_priv$CreditoVivienda)
base_sect_priv$CreditoEmp <- as.numeric(base_sect_priv$CreditoEmp)  


knitr::kable(headTail(base_sect_priv,5,5), col.names = c("Fecha","Cartera de Crédito","Crédito al Consumo","Crédito a la Vivienda","Crédito a Empresas"),format = "latex", booktabs = T, caption = "Financiamiento Otorgado por la Banca Comercial \n Sector Privado 2009-2022", align = "c", digits = 2) %>% kable_styling(latex_options = c("HOLD_position", "scale_down"))
```

Asimismo, podemos analizar las proporciones que cada uno de estos tipos de crédito representa en la cartera de crédito:

```{r}
a <- base_sect_priv$CarteraCredito
b <- base_sect_priv$CreditoConsumo
c <- base_sect_priv$CreditoVivienda
d <- base_sect_priv$CreditoEmp

sect_priv_prop <- base_sect_priv %>% mutate(PTot = a/a*100, PCons = b/a*100, PViv = c/a*100, PEmp = d/a*100) 

sect_priv_prop <- sect_priv_prop[,-c(2:5)]

knitr::kable(headTail(sect_priv_prop,5,5), col.names = c("Fecha","Cartera de Crédito","Crédito al Consumo","Crédito a la Vivienda","Crédito a Empresas"),format = "latex", booktabs = T, caption = "Financiamiento Otorgado por la Banca Comercial \n Sector Privado (Proporciones, Prct) 2009-2022", align = "c", digits = 2) %>% kable_styling(latex_options = c("HOLD_position", "scale_down"))

```

```{r, fig.width = 7, fig.pos='H',fig.cap='Variación (2009-2022): Créditos Otorgados'}
melt_df_5 <- melt(base_sect_priv,id="Fecha")

g1 <- ggplot(melt_df_5,aes(x=as.Date(Fecha, format = "%d/%m/%Y"),y=value,colour=variable,group=variable)) + geom_line() + labs(title = "Variación Absoluta (2009-2022): \nCréditos Otorgados", x="Tiempo",y='Créditos Otorgados', colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 

sect_priv_prop <- sect_priv_prop[,-2]

melt_df_6 <- melt(sect_priv_prop,id="Fecha")


g1
```
```{r, fig.pos='H',fig.cap='Variación Proporcional (2009-2022): Créditos Otorgados'}

ggplot(melt_df_6,aes(x=as.Date(Fecha, format = "%d/%m/%Y"),y=value,colour=variable,group=variable)) + geom_line() + labs(title = "Variación Relativa (2009-2022): \nCréditos Otorgados (mdp)", x="Tiempo",y='Créditos Otorgados \n(Porcentaje del Total)', colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 
```

Puede notarse que, por mucho, el crédito otorgado a empresas y personas físicas con actividad empresarial representa la mayor proporción del total de la cartera de crédito. Hoy, este tipo de créditos representa alrededor del 54\% de la cartera total.

## (c)

**Explique si los datos son consistentes con la hipótesis de que los bancos hacen transformación de madurez o si no lo son y por qué. Para ello posiblemente tenga que hacer supuestos (razonables) o buscar información adicional acerca de la madurez de los distintos tipos de financiamiento y crédito otorgado.**

\hfill

Dado que sólo la información que refiere a uno de los pasivos, *captación*, está catalogada por una categoría de temporalidad (De Exigiblididad Inmediate, A Plazo), se utilizará este pasivo para analizar la transformación de madurez. Además, no es inconveniente utilizar esta variable, ya que hoy en día representa alrededor de un 71\% de los pasivos totales. Es decir, es útil para aproximar la división de pasivos a corto y largo plazo con un margen de error relativamente pequeño.

Por otra parte, en lo que concierne a los recursos/derechos, no hay tal subcategoría que separe por la temporalidad del activo. De esta manera, se hará un supuesto un poco fuerte: **los activos de corto plazo están representados por los créditos al consumo, los de largo plazo por los créditos a la vivienda**. Por otra parte, recordemos que estos créditos son un subconjunto del financiamiento otorgado al sector privado, el cual representa, hoy, alrededor del 65\% del total de los activos (cifra no muy alejada del 71\% arriba mencionado).^[Se hará omisión de la variable "Crédito a Empresas", ya que no se sabe qué porcentaje de los montos están destinados a proyectos de largo o de corto plazo.]


```{r}
fin_pas <- read_excel("Activos_Pasivos.xlsx", sheet = 2)
fin_pas <- fin_pas[-c(1:8),]

fin_pas <- as_data_frame(dplyr::select(fin_pas, c(1,3,5,6,8,9,11,12,14,15,17,18)))

names(fin_pas) <- c("Fecha", "Total_Capt","SP_EI","SP_AP","Ban_Des_EI", "Ban_Des_AP", "IF_EI", "IF_AP", "SPu_EI", "SPu_AP","Ext_EI","Ext_AP")

fin_pas$Total_Capt <-  as.numeric(fin_pas$Total_Capt)
fin_pas$SP_EI <- as.numeric(fin_pas$SP_EI)
fin_pas$SP_AP <- as.numeric(fin_pas$SP_AP)
fin_pas$Ban_Des_EI <- as.numeric(fin_pas$Ban_Des_EI)
fin_pas$Ban_Des_AP <- as.numeric(fin_pas$Ban_Des_AP)
fin_pas$IF_EI <- as.numeric(fin_pas$IF_EI)
fin_pas$IF_AP <- as.numeric(fin_pas$IF_AP)
fin_pas$SPu_EI <- as.numeric(fin_pas$SPu_EI)
fin_pas$SPu_AP <- as.numeric(fin_pas$SPu_AP)
fin_pas$Ext_EI <- as.numeric(fin_pas$Ext_EI)
fin_pas$Ext_AP <- as.numeric(fin_pas$SPu_AP)

knitr::kable(headTail(fin_pas,5,5), format = "latex", booktabs=T, caption = "Captación, por plazos y acreedor del financiamiento") %>% kable_styling(latex_options = c("HOLD_position", "scale_down"))
```

En esta tabla, lo que sigue al "_" denota Exigibilidad Inmediata (EI) y A Plazo (AP). Por otra parte, los prefijos se refieren a:

+ `SP: Sector Privado No Bancario`
+ `Ban_Des: Banca de Desarrollo`
+ `IF: Otros Intermediarios Financieros`
+ `SPu: Sector Público No Financiero`
+ `Ext: Sector No Residente`

Asimismo, conviene capturar la información por el tipo de plazo:

```{r}
ei_ap <- fin_pas %>% mutate(Total_EI = SP_EI+Ban_Des_EI+IF_EI+SPu_EI+Ext_EI, Total_AP = SP_AP+Ban_Des_AP+IF_AP+SPu_AP+Ext_AP) 

ei_ap <- ei_ap %>% dplyr::select(Fecha, Total_EI, Total_AP) %>% mutate(Prop_EI = Total_EI/(Total_EI+Total_AP)*100, Prop_AP = Total_AP/(Total_EI+Total_AP)*100)

knitr::kable(headTail(ei_ap,5,5), format = "latex", booktabs=T, caption = "Madurez de los Pasivos: Absoluta y Relativa", align = "c") %>% kable_styling(latex_options = c("HOLD_position"))
```

Luego, lo que queremos observar es cómo ha variado la proporción a lo largo del tiempo de los pasivos de corto plazo respecto a la de los pasivos de largo plazo: ¿Cómo ha cambiado la manera en que se financian los bancos desde el 2009?

Del mismo modo, quiere analizarse el comportamiento del financiamiento que otorga en los rubros antes considerados: consumo y vivienda. ¿Los bancos prestan más a largo o a corto plazo?

```{r, fig.width = 4, fig.pos='H'}
ei_ap_2 <- ei_ap[,c(1,4,5)]
melt_df_6 <- melt(ei_ap_2,id="Fecha")

grid_1 <- ggplot(melt_df_6, aes(x=as.Date(Fecha, format = "%d/%m/%Y"), y=value ,colour=variable,group=variable))+
  geom_line() + labs(title = "Fin. Recibido \n(Corto vs. Largo Plazo)", x="Tiempo",y = "Porcentaje", colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 
```


```{r, fig.width = 4, fig.pos='H'}

act_plazo <- base_sect_priv %>% mutate(PCorto = CreditoConsumo/(CreditoVivienda+CreditoConsumo)*100, PLar = CreditoVivienda/(CreditoVivienda+CreditoConsumo)*100)

act_plazo <- act_plazo %>% dplyr::select(Fecha, PCorto, PLar)

melt_df_7 <- melt(act_plazo, id="Fecha")

grid_2 <- ggplot(melt_df_7, aes(x=as.Date(Fecha, format = "%d/%m/%Y"), y=value ,colour=variable,group=variable))+
  geom_line() + labs(title = "Fin. Otorgado \n(Corto vs. Largo Plazo)", x="Tiempo",y = "Porcentaje", colour = " ") + scale_y_continuous(labels = comma) + theme_bw() 
```


```{r fig.pos='H', fig.width=10, fig.cap="Tipo de financiamiento (2009-2022): Corto vs Largo"}
plot_grid(grid_1, grid_2, labels = c("A","B"))
```
Como puede observarse en la figura **A**, la banca comercial se ha sustentado cada vez más en las fuentes de financiamiento de corto plazo. Ahora nos queda analizar el comportamiento del financiamiento que otorga en los rubros antes considerados: consumo y vivienda. ¿Los bancos prestan más a largo o a corto plazo?


En cuanto al financiamiento otorgado, ilustrado en figura **B**, parece no haber una tendencia clara. A finales del 2009 y a principios del 2010 el financiamiento de largo plazo se iba incrementando, ganando terreno en el valor total (aunque sin predominar). Sin embargo, éste luego experimenta una caída importante en el 2014 y desde entonces parece tender al alza. Alrededor de 2021 se revierte la predominancia, y los créditos de largo plazo son ahora los que representan la mayoría de los créditos. Es decir, se observa una *transformación de madurez* sólo después del 2020, pues los bancos se están financiando bajo contratos de corto plazo al tiempo que financian proyectos de largo plazo.

## (d)

**Explique qué implica la evolución de las formas de financiamiento y los tipos de crédito otorgados que observó en los incisos anteriores para la estabilidad del sistema financiero a la luz del modelo Diamond-Dybvig.**

\hfill

Por un lado, el financiamiento de captación inmediata ha ido creciendo a lo largo
del tiempo y el de largo plazo ha ido disminuyendo.

Por otro lado, se observa que el crédito a largo plazo ha ido aumentando aproximadamente por 2013. Al mismo tiempo se observa una caída del crédito a corto plazo y un cruce de las tendencias pasado 2020. Esto nos dice que se ha dedicado más de la liquidez para financiar créditos a largo plazo y cada vez menos a corto plazo.

De esta forma se observa que la banca está llevando a cabo la transformación de madurez, es decir, convierte activos líquidos en otros menos líquidos en el largo plazo. De está manera es consistente con el modelo Diamond-Dybvig.

Ahora, cómo se observa, más del 70% del financiamiento es en su mayoría de fuentes de corto plazo. Si estás fuentes son en su mayoría son de disponibilidad inmediata podemos esperar que el sistema financiero mexicano sea sensible a choques macroeconómicos moderados.

## (e) 

**A propósito, documente el incremento dramático a lo largo del tiempo en el crédito hipotecario como proporción del PIB.**

\hfill

Se consideraron los datos trimestrales del PIB y del Crédito Hipotecario del período de 2013 a 2021 a precios de 2013. Los datos del PIB se obtuvieron del BIE del INEGI. Para calcular la proporción de las hipotecas en proporción del PIB se calculó el cociente de las de los valores de las hipotecas entre el PIB. Los resultados se muestrán en la siguiente gráfica. Se observa un crecimiento notable de esta proporción, hay un estrecho repunte en 2020 que puede ser explicado por la caída del PIB debido a la pandemia.

```{r, fig.pos='H',fig.cap='Crédito hipotecario como proporción del PIB'}
library(inegiR)
library(ggplot2)
library(ggfortify)

key<-"fd28a810-4c45-535f-c772-1e81326545e0"

datos <- read.csv("vivienda.csv",sep = "\t")
vivienda <- ts(datos$SF235716,start = c(2003, 1), frequency = 12)
dat_vivienda <- aggregate(vivienda, nfrequency=4, mean)
dat_vivienda <- window(dat_vivienda,start=2003, end=c(2021,4))

pib <- inegi_series(493911,token = key,)
dat_pib <- ts(rev(pib$values),start = c(1980, 1), frequency = 4)
dat_pib <- window(dat_pib,start=2003, end=c(2021,4))


dat_prop <- dat_vivienda/dat_pib

autoplot(dat_prop,ts.colour = "red") +
  labs(title = "Crédito hipotecario como proporción del PIB",
       subtitle = "(2003-2021)",
       x="Tiempo",y='Proporción',) +
  theme_bw()

```

# Ejercicio 3. 

**Estudie al gobierno mexicano y a los corporativos mexicanos desde el punto de vista de su endeudamiento:**

\hfill

## (a)

**Utilice datos del SIE/Valores en Circulación y de SIE/Finanzas públi- cas del Banco de México para describir la evolución a lo largo del tiempo de la composición de la deuda del gobierno mexicano por tipo de instrumento, madurez y moneda. Señale la implicación de lo que encuentre para el riesgo de impago.**

\hfill

En primer lugar se clasifica la deuda pública en interna y externa, la deuda externa está, en general, denominada en moneda extranjera, la deuda interna está denominada en su mayoría en moneda local. La deuda interna y externa puede clasificarse como de corto (menor a un año) y de largo plazo (mayor a un año). Del SIE Banxico/Balanza de Pagos puede obtenerse información acerca de la deuda externa y su madurez.

```{r, echo=FALSE, fig.cap = "Deuda pública en moneda extranjera"}
#Este código permite la descarga directa de la series del SIE BANXICO
tkn <- '13a2eee0e4323e6b8e7583483f63bf485865b8a33de880e88e5c9c51787c89d8'
library(siebanxicor)
setToken(tkn)
idSeriese<-c("SE44970", "SE44976")
dexterna <- getSeriesData(idSeriese, "2009-01-01","2021-12-01") 
dexterna <- as.data.frame(dexterna) %>% dplyr::rename("date" = "SE44970.date") %>% dplyr::rename ("Deuda externa a largo plazo" = "SE44976.value") %>% dplyr::rename ("Deuda externa a corto plazo" = "SE44970.value")

dexterna <- dexterna[,-3]

#Ahora se convierten a series de tiempo con frecuencia trimestral

ts.dexterna <- ts(dexterna, freq = 4, start = c(2009.1))

#Posteriormente se grafica:

plot.1 <- autoplot(ts.dexterna[,2:3], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda en moneda extranjera',
       y = 'Millones de dólares',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.1
```

Se observa que la deuda en moneda extranjera a largo plazo presentó un comportamiento ascendente desde el inicio de la serie en 2009, estabilizandose a partir de 2016. El ascenso inicial puede explicarse por la etapa de bajas tasas de interés externas posterior a la crisis financiera de 2008-2009. La deuda externa a corto plazo es menor que la de largo plazo durante todo el periodo, presenta una tendencia creciente a partir de 2010, alcanzando su nivel más elevado en 2014, para descender nuevamente hasta volver a niveles cercanos a los de 2009 en 2021.

La estructura de la deuda del sector público en moneda extranjera no parece generar un riesgo de impago elevado, la deuda externa a corto plazo es una proporción muy pequeña del total de la deuda externa, además, la deuda a largo plazo se ha mantenido estable desde 2016, incluso durante la pandemia de COVID-19 no muestra cambios significativos.

Posteriormente se muestran las series en cambios de los logarítmos

```{r, echo=FALSE, fig.cap = "Deuda pública moneda extranjera diferencias"}
#Se transforman los datos a cambios trimestre a trimestre de los logaritmos:

ds.dexterna <- as.data.frame(dexterna) %>% mutate(`Cambio en deuda externa a LP` = c(NA, diff(log(`Deuda externa a largo plazo`))), `Cambio en deuda externa a CP` = c(NA, diff(log(`Deuda externa a corto plazo`))))

ts.ds.dexterna <- ts(ds.dexterna, freq = 4, start = c(2009.4))

plot.2 <- autoplot(ts.ds.dexterna[,4:5], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda en moneda extranjera en diferencias',
       y = 'Tasas de cambio',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.2
```
Al graficar en diferencias se observa que la deuda en moneda extranjera a largo plazo tiene más variabilidad que la de corto plazo durante todo el periodo. La variación de la deuda externa alargo plazo es especialmente alta al inicio de la serie en 2009, posteriormente la variabilidad disminuye. La deuda externa a corto plazo muestra poca variabilidad. Ello podría sugerir que el Gobierno Mexicano prefiere financiarse a corto plazo en el mercado interno.

A continuación se presenta un análisis similar para deuda interna, en moneda nacional:

```{r, echo=FALSE, fig.cap = "Deuda interna pública"}
#Este código permite la descarga directa de la series del SIE BANXICO
setToken(tkn)
idSeriesi<-c("SF110508", "SF110509")
dinterna <- getSeriesData(idSeriesi, "2009-06-01","2021-12-01") 
dinterna <- as.data.frame(dinterna) %>% dplyr::rename("date" = "SF110508.date") %>% dplyr::rename ("Deuda interna a corto plazo" = "SF110508.value") %>% dplyr::rename ("Deuda interna largo plazo" = "SF110509.value")

dinterna <- dinterna[,-3]

#Ahora se convierten a series de tiempo con frecuencia trimestral

ts.dinterna <- ts(dinterna, freq = 12, start = c(2009.6))

#Posteriormente se grafica:

plot.3 <- autoplot(ts.dinterna[,2:3], colour = 'blue') + theme_bw() +
  labs(title = 'Deuda en moneda nacional',
       y = 'Miles de millones de pesos',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.3
```

Se observan diferencuas muy relevantes entre la deuda interna a corto y a largo plazo, la deuda en moneda nacional a largo plazo muestra ua tendencia creciente relativamente pronunciada durante todo el periodo (junio 2009 - diciembre 2021). La deuda interna presenta una tendencia de reducción hasta mediados de 2011, posteriormente presenta un aumento moderado, después de 2020 la deuda interna también presenta una tendencia claramente creciente. En el caso de la deuda en moneda nacional se observan tendencias crecientes en la de corto y largo plazo, resulta relevante analisar las tasas a las que crece, por ello se presentan las series en diferencias de sus logartimos.

```{r, echo=FALSE, fig.cap = "Deuda interna pública en diferencias"}
#Se transforman los datos a cambios mes a mes de los logaritmos:

ds.dinterna <- as.data.frame(dinterna) %>% mutate(`Cambio en deuda interna largo plazo` = c(NA, diff(log(`Deuda interna largo plazo`))), `Cambio en deuda interna a largo plazo` = c(NA, diff(log(`Deuda interna a corto plazo`))))

ts.ds.dinterna <- ts(ds.dinterna, freq = 12, start = c(2009.6))

plot.4 <- autoplot(ts.ds.dinterna[,4:5], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda en moneda nacional en diferencias',
       y = 'Tasas de cambio',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.4
```

De nuevo se observa una mayor variabilidad en el comportamiento de la deuda a largo plazo, en este caso en moneda nacional, se observan tasas negativas de endeudamiento a largo plazo alrededor de 2011 y tasas positivas y "elevadas" en 2020, lo que sugiere un aumento en el endeudamiento a largo plazo al inicio de la pandemia por COVID-19. La deuda interna acorto plazo presenta menor variabilidad. Es necesario observar el comportamiento en los próximos meses y años de la deuda interna a largo plazo, pues si no se estabilizara representaría un aumento en el riesgo de impago.

Ahora se presenta la evolución de algunos instrumentos de deuda en moneda nacional del Gobierno Mexicano. Se entenderá por tipo de instrumento al tipo de tasa, es decir, tasa de interés fija o variable; también se considero incluir instrumentos como CETES, BONDES, BONOS y UDIBONOS, pero al tratarse de una pregunta acerca del riesgo de impago se considera de mayor relevancia incluir la clasificación por instrumentos de tasas fija y variable.

```{r, echo=FALSE, fig.cap = "Deuda interna pública por tipo"}
#Este código permite la descarga directa de la series del SIE BANXICO
setToken(tkn)
idSeriest<-c("SF110513", "SF110515")
dinternat <- getSeriesData(idSeriest, "2009-06-01","2021-12-01") 
dinternat <- as.data.frame(dinternat) %>% dplyr::rename("date" = "SF110513.date") %>% dplyr::rename ("Deuda interna a tasa fija" = "SF110513.value") %>% dplyr::rename ("Deuda interna a tasa variable" = "SF110515.value")

dinternat <- dinternat[,-3]

#Ahora se convierten a series de tiempo con frecuencia trimestral

ts.dinternat <- ts(dinternat, freq = 12, start = c(2009.6))

#Posteriormente se grafica:

plot.5 <- autoplot(ts.dinternat[,2:3], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda por tipo de tasa',
       y = 'Miles de millones de pesos',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.5
```

Se observa una tendencia creciente en ambos tipos de deuda, sin embargo la deuda a tasa fija parece crecer de forma más acelerada que la deuda a tasa variable. A inicios de 2021 se observa una aceleración en el crecimiento de la deuda a tasa variable, probablemente por el inicio del ciclo de alsa en tasas. También se presentan las gráficas en tasas de cambio:

```{r, echo=FALSE, fig.cap = "Deuda interna pública por tipo en diferencias"}
#Se transforman los datos a cambios mes a mes de los logaritmos:

ds.dinternat <- as.data.frame(dinternat) %>% mutate(`Cambio en deuda a tasa fija` = c(NA, diff(log(`Deuda interna a tasa fija`))), `Cambio en deuda tasa variable` = c(NA, diff(log(`Deuda interna a tasa variable`))))

ts.ds.dinternat <- ts(ds.dinternat, freq = 12, start = c(2009.6))

plot.6 <- autoplot(ts.ds.dinternat[,4:5], colour = 'blue') + theme_bw() +
  labs(title = 'Deuda por tipo de tasa en diferencias',
       y = 'Tasas de cambio',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.6
```

Se observa una mayor variabilidad en la deuda interna a tasa variable, la deuda interna a tasa fija varía dentro de un rango más estrecho, pero positivo. A partir de 2021 se observan variaciones positivas y crecientes en la deuda tasa variable. De mantenerse la tendencia, ello podría representar un riesgo de impago, sobretodo al incluir los efectos de un aumento en las tasas de interés externas e internas.

\hfill

## (b) 

**Utilice datos del SIE/Valores en Circulación o para describir la com- posición a lo largo del tiempo de la deuda del del sector privado no financiero mexicano por madurez y moneda. Señale la implicación de lo que encuentre para el riesgo de impago.**

\hfill

De nuevo, se clasifica la deuda privada de instituciones no financieras en moneda extranjeta (proxy deuda emitida en el exterior) y en moneda nacional (proxy deuda emitida en el mercado interno). La primera serie se encuentra en la sección de Balanza de Pagos y la segunda en la sección valores en circulación del SIE. Además se presenta sus clasificación por madurez (corto y largo plazo).

```{r, echo=FALSE, fig.cap = "Deuda privada moneda extranjera"}
#Este código permite la descarga directa de la series del SIE BANXICO
tkn <- '13a2eee0e4323e6b8e7583483f63bf485865b8a33de880e88e5c9c51787c89d8'
library(siebanxicor)
setToken(tkn)
idSeriesep<-c("SE45104", "SE45110")
dexternap <- getSeriesData(idSeriesep, "2009-01-01","2021-12-01") 
dexternap <- as.data.frame(dexternap) %>% dplyr::rename("date" = "SE45104.date") %>% dplyr::rename ("Deuda externa privada a largo plazo" = "SE45110.value") %>% dplyr::rename ("Deuda externa privada a corto plazo" = "SE45104.value")

dexternap <- dexternap[,-3]

#Ahora se convierten a series de tiempo con frecuencia trimestral

ts.dexternap <- ts(dexternap, freq = 4, start = c(2009.1))

#Posteriormente se grafica:

plot.7 <- autoplot(ts.dexternap[,2:3], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda privada moneda extranjera',
       y = 'Millones de dólares',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.7
```

Se observa que la deuda en moneda extranjera de instituciones no financieras se emite en su mayoria a largo plazo, de 2009 a 2015 se observa un crecimiento acelerado de la deuda en moneda extranjera a largo plazo, para estabilizarse a partir de 2015. La deuda en moneda extranjera a corto plazo se ha mantenido relativamente estable presentando una ligera tendencia creciente durante todo el periodo. Posteriormente se presentan los mismos datos en diferencias de sus logaritmos:

```{r, echo=FALSE, fig.cap = "Deuda privada en moneda extranjera en diferencias"}
#Se transforman los datos a cambios trimestre a trimestre de los logaritmos:

ds.dexternap <- as.data.frame(dexternap) %>% mutate(`Cambio en deuda privada en moneda extranjera a LP` = c(NA, diff(log(`Deuda externa privada a largo plazo`))), `Cambio en deuda privada en moneda extranjera a CP` = c(NA, diff(log(`Deuda externa privada a corto plazo`))))

ts.ds.dexternap <- ts(ds.dexternap, freq = 4, start = c(2009.4))

plot.8 <- autoplot(ts.ds.dexternap[,4:5], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda privada en moneda extranjera en diferencias',
       y = 'Tasas de cambio',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.8
```
Se observa una mayor variación en la deuda privada en moneda extranjera a corto plazo que a largo plazo. Al inicio de la serie la deuda privada en moneda extranjera a largo plazo presentaba una mayor variabilidad que al final de la serie.

Ahora se presenta la composición en términos de mamdurez de la deuda privada no financiera emitida en el mercado doméstico mexicano.

```{r, echo=FALSE, fig.cap = "Deuda privada interna"}
#Este código permite la descarga directa de la series del SIE BANXICO
setToken(tkn)
idSeriesip<-c("SF110356", "SF110357")
dinternap <- getSeriesData(idSeriesip, "2009-06-01","2021-12-01") 
dinternap <- as.data.frame(dinternap) %>% dplyr::rename("date" = "SF110356.date") %>% dplyr::rename ("Deuda privada a corto plazo" = "SF110356.value") %>% dplyr::rename ("Deuda privada largo plazo" = "SF110357.value")

dinternap <- dinternap[,-3]

#Ahora se convierten a series de tiempo con frecuencia trimestral

ts.dinternap <- ts(dinternap, freq = 12, start = c(2009.6))

#Posteriormente se grafica:

plot.9 <- autoplot(ts.dinternap[,2:3], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda privada',
       y = 'Miles de millones de pesos',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.9
```
Se observa que la deuda privada de instituciones no financieras a largo plazo presenta una tendencia creciente durante todo el periodo. La deuda a corto plazo no ha presentado variaciones relevantes, se ha mantenido durante le periodo que se incluye en las series. A continuación se presentan las series en diferencias de sus logarítmos.

```{r, echo=FALSE, fig.cap = "Deuda privada interna en diferencias"}
#Se transforman los datos a cambios mes a mes de los logaritmos:

ds.dinternap <- as.data.frame(dinternap) %>% mutate(`Cambio en deuda privada LP` = c(NA, diff(log(`Deuda privada largo plazo`))), `Cambio en deuda privada a CP` = c(NA, diff(log(`Deuda privada a corto plazo`))))

ts.ds.dinternap <- ts(ds.dinternap, freq = 12, start = c(2009.6))

plot.10 <- autoplot(ts.ds.dinternap[,4:5], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda privada en diferencias',
       y = 'Tasas de cambio',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.10
```
Se observa una mayor variabilidad en la deuda privada a corto plazo que a largo plazo. Sin embargo el aumento mostrado por la deuda privada a largo plazo de la grafica en términos absolutos señala una tendencia creciente que no parece haberse estabilizado. Como la deuda a corto plazo es pequeña comparada con la deuda a largo plazo parece ser poco probable que las empresas mexicanas experimenten dificultades en cubrir sus obligaciones o refinanciarse, sin embargo es necesario estudiar cuidadosamente la tendencia de la deuda a largo plazo para evitar que se convierta en un problema futuro.

\hfill

## (c) 

**Describa la evolución de las cifras anteriores durante la pandemia de Covid-19, es decir entre principios de 2020 y hasta la fecha.**

\hfill

En primer lugar se estudia la evolución de la deuda pública en moneda extranjera de corto y largo plazo a partir de 2020:

```{r, echo=FALSE, fig.cap = "Deuda pública en moneda extranjera 2020-2022"}
x <- ts(dexterna[-(1:44),], freq = 4, start = c(2020))
plot.11 <- autoplot(x[,2:3], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda pública en moneda extranjera',
       y = 'Millones de dólares',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.11
```
Se observa una tendencia al alza de la deuda externa a corto plazo durante los primeros meses de la pandemia por COVID-19, posteriormente la tendencia es de descenso sostenido.

En el caso de la deuda pública en moneda extranjera a largo plazo se presenta una fuerte tendencia al alza en los primeros meses de la pandemia, alcanzando un pico en el tercer trimestre de 2020 y comenzando un descenso sostenido.
Ahora se presenta el comportamiento de la deuda privada:

```{r, echo=FALSE, fig.cap = "Deuda privada en moneda extranjera 2020-2022"}
y <- ts(dexternap[-(1:44),], freq = 4, start = c(2020))
plot.13 <- autoplot(y[,2:3], colour = 'blue') + theme_bw() +
  labs(title = 'Deuda privada en moneda extranjera',
       y = 'Millones de dólares',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.13
```

La deuda privada de instituciones no financieras a corto plazo presenta una tendencia decreciente a partir del inicio de la contingencia por COVID 19, posiblemente para cubrise del riesgo de impago, posteriormente presenta variaciones al alza que continuan al final del periodo (2021-IV).

La deuda privada en moneda extranjera a LP presenta una tendencia creciente al inicio de la contingencia por COVID-19, posteriormente la tendencia no es clara.

Ahora se presenta la tendencia en la deuda pública emitida en el país a corto y largo plazo a partir de 2020.

```{r, echo=FALSE, fig.cap = "Deuda publica interna 2020-2022"}
xx <- ts(dinterna[-(1:127),], freq = 12, start = c(2020))
plot.15 <- autoplot(xx[,2:3], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda publica interna',
       y = 'Miles de millones de pesos',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.15
```

La serie de deuda pública interna a corto plazo muestra una tendencia creciente a partir del inicio de la pandemia por COVID-19.

La deuda pública interna a largo plazo también presenta una tendencia alcista, pero con un lag de aproximadamente un trimestre respecto al inicio de la contingencia sanitaria, la tendencia continúa hasta el fin de la serie en 2022.A continuación se analiza el comportamiento de la deuda privada emitida en el mercado interno a corto y largo plazo.

```{r, echo=FALSE, fig.cap = "Deuda privada interna 2020-2022"}
yy <- ts(dinternap[-(1:127),], freq = 12, start = c(2020))
plot.17 <- autoplot(yy[,2:3], colour = 'blue') + theme_bw() + 
  labs(title = 'Deuda privada local',
       y = 'Miles de millones de pesos',
       x = 'Año',
       caption = 'Fuente: Elaboración propia con datos de Banxico')
plot.17
```

La deuda interna privada a corto plazo muestra una tendencia al alza a partir de la contingencia por COVID-19, posiblemente para poder cubrir salarios y costos fijos durante en el tiempo de cierre, posteriormente se estabiliza y comienza a descender a menores niveles que los prepandemicoshacia finales de la serie.

Se obserca que la deuda privada a largo plazo desciende al inicio de la contingencia sanitaria para que, a unos meses del inicio de la pandemia inicie una tendencia de crecimiento que parece continuar al final de la serie en diciembre de 2021.

En general se concluye que la deuda a corto plazo reaccionó antes, la deuda a largo plazo presenta un lag para iniciar su crecimiento, la causa probable de este fenómeno es que resulta más simple y rápido obtener financiamiento a corto plazo que a largo plazo.
